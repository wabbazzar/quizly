import{e,p as s,r as n,j as t,B as i,c as r,u as a,b as o}from"./index-K5uqA-3n.js";import{P as l}from"./PageHeader-DPZ1jwk0.js";import{U as c}from"./UnifiedSettings-HzgFl0jR.js";import{S as d}from"./SettingsIcon-BSlFCqwD.js";const u={answerType:"free_text",checkMode:"wait",translationDirection:{from:"a",to:"c"},optionsCount:4,showPinyinDefault:!1,multipleChoiceDifficulty:"medium",unit:"character",translationMode:"sentence",accuracyThreshold:70,showWordHints:!0},h=e()(s((e,s)=>({progress:{},session:null,settings:u,initSession:(s,n)=>{e(e=>({session:{deckId:s,currentDialogueId:n,currentLineIndex:0,currentTokenIndex:0,showPinyin:e.settings.showPinyinDefault,showTranslation:!1,correctCount:0,incorrectCount:0,startTime:Date.now(),responseStartTime:Date.now(),responseTimes:[]}}))},setCurrentDialogue:s=>{e(e=>{if(!e.session)return e;const n=e.session.deckId,t=e.progress[n]||{dialogueId:s,lineIndex:0,tokenIndex:0,completedTokens:new Set,masteredTokens:new Set};return{progress:{...e.progress,[n]:{...t,dialogueId:s}},session:{...e.session,currentDialogueId:s,currentLineIndex:0,currentTokenIndex:0}}})},setCurrentLine:s=>{e(e=>{if(!e.session)return e;const n=e.session.deckId,t=e.session.currentDialogueId||"",i=e.progress[n]||{dialogueId:t,lineIndex:0,tokenIndex:0,completedTokens:new Set,masteredTokens:new Set};return{progress:{...e.progress,[n]:{...i,lineIndex:s}},session:{...e.session,currentLineIndex:s,currentTokenIndex:0}}})},setCurrentToken:s=>{e(e=>{if(!e.session)return e;const n=e.session.deckId,t=e.session.currentDialogueId||"",i=e.session.currentLineIndex,r=e.progress[n]||{dialogueId:t,lineIndex:i,tokenIndex:0,completedTokens:new Set,masteredTokens:new Set};return{progress:{...e.progress,[n]:{...r,tokenIndex:s}},session:{...e.session,currentTokenIndex:s,responseStartTime:Date.now()}}})},markTokenComplete:(s,n,t)=>{e(e=>{if(!e.session)return e;const i=e.session.deckId,r=`${s}:${n}:${t}`,a=e.progress[i]||{dialogueId:s,lineIndex:0,tokenIndex:0,completedTokens:new Set,masteredTokens:new Set},o=new Set(a.completedTokens);return o.add(r),{progress:{...e.progress,[i]:{...a,completedTokens:o}}}})},markTokenMastered:(s,n,t)=>{e(e=>{if(!e.session)return e;const i=e.session.deckId,r=`${s}:${n}:${t}`,a=e.progress[i]||{dialogueId:s,lineIndex:0,tokenIndex:0,completedTokens:new Set,masteredTokens:new Set},o=new Set(a.masteredTokens);o.add(r);const l=new Set(a.completedTokens);return l.add(r),{progress:{...e.progress,[i]:{...a,completedTokens:l,masteredTokens:o}}}})},togglePinyin:()=>{e(e=>e.session?{session:{...e.session,showPinyin:!e.session.showPinyin}}:e)},toggleTranslation:()=>{e(e=>e.session?{session:{...e.session,showTranslation:!e.session.showTranslation}}:e)},updateSettings:s=>{e(e=>({settings:{...e.settings,...s},session:e.session&&void 0!==s.showPinyinDefault?{...e.session,showPinyin:s.showPinyinDefault}:e.session}))},recordAnswer:(s,n)=>{e(e=>e.session?{session:{...e.session,correctCount:e.session.correctCount+(s?1:0),incorrectCount:e.session.incorrectCount+(s?0:1),responseTimes:[...e.session.responseTimes,n]}}:e)},clearSession:()=>{e({session:null})},resetProgress:s=>{e(e=>{const n={...e.progress};return delete n[s],{progress:n}})},getProgress:e=>s().progress[e]||null}),{name:"read-store",version:2,partialize:e=>({progress:e.progress,settings:e.settings}),migrate:(e,s)=>s<2?{...e,settings:{...u,...e.settings,translationMode:e.settings?.translationMode||"sentence",accuracyThreshold:e.settings?.accuracyThreshold||70,showWordHints:!1!==e.settings?.showWordHints}}:e})),_="_container_15iu2_1",m="_title_15iu2_7",g="_dialogueList_15iu2_14",x="_dialogueButton_15iu2_20",p="_selected_15iu2_33",f="_dialogueContent_15iu2_44",v="_dialogueHeader_15iu2_51",j="_dialogueName_15iu2_57",k="_completeIcon_15iu2_78",w="_dialogueInfo_15iu2_82",N="_lineCount_15iu2_91",y="_progress_15iu2_96",C="_progressBar_15iu2_119",b="_progressFill_15iu2_128",T=({deck:e,selectedDialogueId:s,onSelectDialogue:r,progress:a})=>{const o=n.useMemo(()=>{if(!e.reading)return{};const s={};return Object.entries(e.reading.dialogues).forEach(([e,n])=>{const t=n.lines.reduce((e,s)=>{let n=0;return s.a&&n++,s.b&&n++,s.c&&n++,e+n},0),i=a?.completedTokens?Array.from(a.completedTokens).filter(s=>s.startsWith(`${e}:`)).length:0;s[e]={completed:i,total:t}}),s},[e,a]);if(!e.reading)return null;const l=Object.entries(e.reading.dialogues);return t.jsxs("div",{className:_,children:[t.jsx("h3",{className:m,children:"Dialogues"}),t.jsx("div",{className:g,children:l.map(([e,n])=>{const a=s===e,l=o[e],c=l?l.completed/l.total*100:0,d=e.replace(/dialogue(\d+)/,"Dialogue $1").replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase());return t.jsx(i,{variant:a?"primary":"secondary",className:`${x} ${a?p:""}`,onClick:()=>r(e),children:t.jsxs("div",{className:f,children:[t.jsxs("div",{className:v,children:[t.jsx("span",{className:j,children:d}),100===c&&t.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",className:k,children:t.jsx("path",{d:"M20 6L9 17L4 12"})})]}),t.jsxs("div",{className:w,children:[t.jsxs("span",{className:N,children:[n.lines.length," lines"]}),l&&l.completed>0&&t.jsxs("span",{className:y,children:[l.completed,"/",l.total," tokens"]})]}),c>0&&c<100&&t.jsx("div",{className:C,children:t.jsx("div",{className:b,style:{width:`${c}%`}})})]})},e)})})]})};function I(e,s){const n=S(e),t=S(s);if(n===t)return 100;if(0===n.length&&0===t.length)return 100;if(0===n.length||0===t.length)return 0;const i=Math.max(n.length,t.length),r=function(e,s){const n=Array(s.length+1).fill(null).map(()=>Array(e.length+1).fill(null));for(let t=0;t<=e.length;t+=1)n[0][t]=t;for(let t=0;t<=s.length;t+=1)n[t][0]=t;for(let t=1;t<=s.length;t+=1)for(let i=1;i<=e.length;i+=1){const r=e[i-1]===s[t-1]?0:1;n[t][i]=Math.min(n[t][i-1]+1,n[t-1][i]+1,n[t-1][i-1]+r)}return n[s.length][e.length]}(n,t);return Math.max(0,(i-r)/i*100)}function S(e){return e.toLowerCase().trim().replace(/[.,!?;:()\[\]{}"'`~@#$%^&*+=\-\/\\|<>]/g,"").replace(/\s+/g," ").trim()}function M(e){return S(e).split(/\s+/).filter(e=>e.length>0)}function L(e,s,n,t=70){const i=function(e,s){const n=[],t=e[s];if(t&&n.push(t),e.wordAlignments&&"c"===s){const s=e.wordAlignments.filter(e=>e.english.trim().length>0).map(e=>e.english.trim());s.length>0&&n.push(s.join(" "))}return[...new Set(n)]}(s,n),r=i[0]||"";if(!r)return{userAnswer:e,correctAnswer:"",accuracy:0,isCorrect:!1,suggestions:[]};let a=0,o=r;i.forEach(s=>{const n=I(e,s);n>a&&(a=n,o=s)});const l=function(e,s){const n=M(e),t=M(s),i=new Set;return n.map(e=>{let s=null,n=0;return t.forEach(t=>{if(i.has(t))return;const r=I(e,t);r>n&&r>=70&&(s=t,n=r)}),s?(i.add(s),{word:e,matched:!0,similarity:n}):{word:e,matched:!1}})}(e,o),c=a>=t;return{userAnswer:e,correctAnswer:o,accuracy:Math.round(a),isCorrect:c,wordMatches:l,suggestions:i.slice(1)}}function D(e){return e.wordAlignments&&0!==e.wordAlignments.length?e.wordAlignments.map((e,s)=>({chinese:e.chinese,pinyin:e.pinyin,english:e.english,index:s})):[]}function P(e){return Boolean(e.wordAlignments&&e.wordAlignments.length>0)}const A="_container_14i12_1",$="_sourceSection_14i12_9",z="_sectionLabel_14i12_15",B="_sourceText_14i12_23",E="_staticSource_14i12_38",H="_interactiveSource_14i12_55",W="_wordTokensContainer_14i12_63",q="_wordToken_14i12_63",U="_clickable_14i12_93",F="_static_14i12_38",R="_hintText_14i12_108",O="_answerSection_14i12_114",G="_freeTextSection_14i12_120",K="_textInput_14i12_126",X="_submitted_14i12_147",J="_multipleChoiceSection_14i12_156",V="_option_14i12_162",Y="_selected_14i12_184",Q="_correct_14i12_189",Z="_incorrect_14i12_194",ee="_optionLetter_14i12_204",se="_optionText_14i12_226",ne="_actions_14i12_236",te="_submitButton_14i12_243",ie="_skipButton_14i12_247",re="_resultSection_14i12_251",ae="_resultHeader_14i12_265",oe="_accuracyScore_14i12_281",le="_resultStatus_14i12_286",ce="_correctAnswer_14i12_291",de="_correctLabel_14i12_301",ue="_correctText_14i12_307",he="_wordAnalysis_14i12_315",_e="_analysisLabel_14i12_321",me="_wordMatches_14i12_327",ge="_wordMatch_14i12_327",xe="_matched_14i12_341",pe="_unmatched_14i12_347",fe="_suggestions_14i12_353",ve="_suggestionsLabel_14i12_359",je="_suggestionsList_14i12_365",ke="_suggestion_14i12_353",we=({line:e,allLines:s,settings:r,onAnswer:a,onSkip:o,showResult:l=!1,disabled:c=!1})=>{const[d,u]=n.useState(""),[h,_]=n.useState(null),[m,g]=n.useState(null),x=e[r.translationDirection.from]||"",p=n.useMemo(()=>"multiple_choice"===r.answerType?function(e,s,n,t=4,i="medium"){const r=e[s];if(!r)return[];const a=[r],o=new Set([S(r)]),l=[];"easy"===i&&Object.keys(e).forEach(n=>{if(n!==s&&"string"==typeof e[n]){const s=e[n];s&&!o.has(S(s))&&l.push(s)}}),n.forEach(n=>{if(n===e)return;const t=n[s];t&&!o.has(S(t))&&l.push(t)});const c=l.sort(()=>Math.random()-.5).slice(0,t-1);return a.push(...c),a.sort(()=>Math.random()-.5)}(e,r.translationDirection.to,s,r.optionsCount||4,r.multipleChoiceDifficulty||"medium"):[],[e,s,r]),f=n.useMemo(()=>P(e),[e]),v=n.useMemo(()=>f?D(e):[],[e,f]),j=n.useCallback(()=>{if(c||m)return;const s=L("multiple_choice"===r.answerType?h||"":d,e,r.translationDirection.to,r.accuracyThreshold||70);g(s),a(s)},[d,h,r,e,a,c,m]),k=n.useCallback(s=>{c||m||(_(s),"live"===r.checkMode&&setTimeout(()=>{const n=L(s,e,r.translationDirection.to,r.accuracyThreshold||70);g(n),a(n)},100))},[r,e,a,c,m]),w=n.useCallback(e=>{c||m||(u(e.target.value),"live"===r.checkMode&&e.target.value.trim())},[r,c,m]),N=n.useCallback(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),j())},[j]),y=n.useCallback(s=>{if(!r.showWordHints||!f)return;!function(e,s,n){if(!e.wordAlignments)return null;const t=e.wordAlignments.find(e=>e.chinese===s);if(!t)return null;const i={};t.pinyin&&t.pinyin.trim()&&(i.pinyin=t.pinyin),"c"===n&&t.english&&t.english.trim()&&(i.translation=t.english),Object.keys(i).length}(e,s,r.translationDirection.to)},[e,r,f]);n.useEffect(()=>{u(""),_(null),g(null)},[e]);const C="multiple_choice"===r.answerType?null!==h:d.trim().length>0;return t.jsxs("div",{className:A,children:[t.jsxs("div",{className:$,children:[t.jsx("div",{className:z,children:"Translate this sentence:"}),t.jsx("div",{className:B,children:f&&r.showWordHints?t.jsxs("div",{className:H,children:[t.jsx("div",{className:W,children:v.map((e,s)=>t.jsx("span",{className:`${q} ${e.english?U:F}`,onClick:()=>y(e.chinese),title:e.english?`${e.pinyin} - ${e.english}`:void 0,children:e.chinese},s))}),t.jsx("div",{className:R,children:"Tap words for hints"})]}):t.jsx("div",{className:E,children:x})})]}),t.jsxs("div",{className:O,children:[t.jsx("div",{className:z,children:"Your translation:"}),"free_text"===r.answerType?t.jsx("div",{className:G,children:t.jsx("textarea",{className:`${K} ${m?X:""}`,value:d,onChange:w,onKeyPress:N,placeholder:"Type your translation here...",disabled:c||!!m,rows:3})}):t.jsx("div",{className:J,children:p.map((e,s)=>t.jsxs("button",{className:`${V} ${h===e?Y:""} ${m?e===m.correctAnswer?Q:h===e?Z:"":""}`,onClick:()=>k(e),disabled:c||!!m,children:[t.jsx("span",{className:ee,children:String.fromCharCode(65+s)}),t.jsx("span",{className:se,children:e})]},s))})]}),!m&&t.jsxs("div",{className:ne,children:["wait"===r.checkMode&&t.jsx(i,{variant:"primary",onClick:j,disabled:!C||c,className:te,children:"Check Answer"}),o&&t.jsx(i,{variant:"secondary",onClick:o,disabled:c,className:ie,children:"Skip"})]}),m&&l&&t.jsxs("div",{className:re,children:[t.jsxs("div",{className:`${ae} ${m.isCorrect?Q:Z}`,children:[t.jsxs("div",{className:oe,children:[m.accuracy,"% accuracy"]}),t.jsx("div",{className:le,children:m.isCorrect?"Correct!":"Needs improvement"})]}),!m.isCorrect&&t.jsxs("div",{className:ce,children:[t.jsx("div",{className:de,children:"Correct answer:"}),t.jsx("div",{className:ue,children:m.correctAnswer})]}),m.wordMatches&&m.wordMatches.length>0&&t.jsxs("div",{className:he,children:[t.jsx("div",{className:_e,children:"Word analysis:"}),t.jsx("div",{className:me,children:m.wordMatches.map((e,s)=>t.jsx("span",{className:`${ge} ${e.matched?xe:pe}`,title:e.similarity?`${Math.round(e.similarity)}% match`:void 0,children:e.word},s))})]}),m.suggestions&&m.suggestions.length>0&&t.jsxs("div",{className:fe,children:[t.jsx("div",{className:ve,children:"Alternative answers:"}),t.jsx("div",{className:je,children:m.suggestions.map((e,s)=>t.jsx("div",{className:ke,children:e},s))})]})]})]})},Ne={unit:{a:"character",b:"space",c:"space",d:void 0,e:void 0,f:void 0},preservePunctuation:!0},ye=e=>{const s=e.charCodeAt(0);return s>=19968&&s<=40959||s>=13312&&s<=19903||s>=131072&&s<=173791||s>=173824&&s<=177983||s>=177984&&s<=178207||s>=12352&&s<=12447||s>=12448&&s<=12543||s>=44032&&s<=55215},Ce=(e,s)=>{const n=[];for(let t=0;t<e.length;t++){const i=e[t];!s&&/\s|[.,!?;:]/.test(i)||(/\s/.test(i)||n.push({text:i,start:t,end:t+1}))}return n},be=(e,s)=>{const n=[];let t="",i=0;for(let r=0;r<=e.length;r++){const a=e[r];if(r===e.length||/\s/.test(a)){if(t){let e=t;s||(e=e.replace(/[.,!?;:]+$/,"")),e&&n.push({text:e,start:i,end:i+e.length}),t=""}i=r+1}else""===t&&(i=r),t+=a}return n},Te=(e,s)=>be(e,s),Ie=(e,s)=>{const n=e.replace(/\s/g,"").length,t=Array.from(e).filter(ye).length;return t>0&&t/n>.3?Ce(e,s):be(e,s)},Se=e=>{const s={a:[],b:[],c:[]};let n=0,t=0,i=0;return e.forEach(e=>{s.a.push({text:e.chinese,start:n,end:n+e.chinese.length}),n+=e.chinese.length,s.b.push({text:e.pinyin,start:t,end:t+e.pinyin.length}),t+=e.pinyin.length+1,s.c.push({text:e.english,start:i,end:i+e.english.length}),i+=e.english.length+1}),s},Me=(e,s)=>{let n=e;const t={caseSensitive:!1,removeSpaces:!1,removePunctuation:!0,...s};return t.caseSensitive||(n=n.toLowerCase()),t.removePunctuation&&(n=n.replace(/[.,!?;:'"]/g,"")),n=t.removeSpaces?n.replace(/\s+/g,""):n.replace(/\s+/g," ").trim(),n},Le=(e,s)=>{const n=e.length,t=s.length;if(0===n)return t;if(0===t)return n;const i=Array(n+1).fill(null).map(()=>Array(t+1).fill(0));for(let r=0;r<=n;r++)i[r][0]=r;for(let r=0;r<=t;r++)i[0][r]=r;for(let r=1;r<=n;r++)for(let n=1;n<=t;n++)e[r-1]===s[n-1]?i[r][n]=i[r-1][n-1]:i[r][n]=Math.min(i[r-1][n]+1,i[r][n-1]+1,i[r-1][n-1]+1);return i[n][t]},De=e=>e.toLowerCase().replace(/[āáǎà]/g,"a").replace(/[ēéěè]/g,"e").replace(/[īíǐì]/g,"i").replace(/[ōóǒò]/g,"o").replace(/[ūúǔù]/g,"u").replace(/[ǖǘǚǜü]/g,"v").replace(/[ńňǹ]/g,"n").replace(/[ḿ]/g,"m").trim(),Pe=(e,s,n=2,t="text")=>{if("pinyin"===t)return((e,s,n=1)=>{const t=De(e),i=De(s);return t===i||Le(t,i)<=Math.min(n,Math.floor(.15*i.length))})(e,s,n);const i=Me(e),r=Me(s);if(i===r)return!0;return Le(i,r)<=Math.min(n,Math.floor(.2*r.length))},Ae="_token_1oofa_1",$e="_active_1oofa_17",ze="_completed_1oofa_27",Be="_correct_1oofa_31",Ee="_incorrect_1oofa_36",He="_tokenText_1oofa_41",We="_interactionArea_1oofa_46",qe="_closeButton_1oofa_60",Ue="_freeTextInput_1oofa_92",Fe="_textInput_1oofa_98",Re="_multipleChoice_1oofa_114",Oe="_mcOption_1oofa_120",Ge="_answerDisplay_1oofa_130",Ke="_correctAnswer_1oofa_142",Xe="_feedbackCorrect_1oofa_147",Je="_feedbackIncorrect_1oofa_152",Ve="_pinyinHint_1oofa_157",Ye="_translationHint_1oofa_168",Qe=({isActive:e,isCompleted:s,onClick:r,onClose:a,onComplete:o,settings:l,sourceText:c,targetText:d,pinyinText:u,translationText:h})=>{const[_,m]=n.useState(""),[g,x]=n.useState(!1),[p,f]=n.useState(null),[v,j]=n.useState([]),[k,w]=n.useState({top:0,left:0}),N=n.useRef(null),y=e=>/^[.,!?;:()\[\]{}"'`~@#$%^&*+=\-\/\\|<>]+$/.test(e),C=(e,s)=>!(!y(e)||!y(s))||(!s||!s.trim());n.useEffect(()=>{if("multiple_choice"===l.answerType&&e&&d){if(C(c,d))return void(o&&setTimeout(()=>o(),500));const e=[d];let s=[];const n=l.translationDirection.to;if(/^\d+$/.test(d)){const e=parseInt(d);s=[(e-1).toString(),(e+1).toString(),(2*e).toString(),(e+10).toString(),Math.floor(e/2).toString()].filter(e=>e!==d&&parseInt(e)>=0)}else if("b"===n){const e=["ma","wo","ni","ta","de","shi","zai","you","ge","le","dao","shang","xia","lai","qu","hao","hen","dou","bu","mei","kan","shuo","zuo","chi","he","zou","pao","fei","kai","guan","da","xiao","gao","ai","pang","shou","kuai","man","xin","jiu","duo","shao","chang","duan","yuan","jin","li","wai","zhong","bian","qian","hou","zuo","you","dong","xi","nan","bei","bai","hei","hong","lu","huang","lan","zi","fen","hui","zong","cheng","qing"],n=[...e];e.forEach(e=>{e.includes("a")&&n.push(e.replace("a","ā"),e.replace("a","á"),e.replace("a","ǎ"),e.replace("a","à")),e.includes("e")&&n.push(e.replace("e","ē"),e.replace("e","é"),e.replace("e","ě"),e.replace("e","è")),e.includes("i")&&n.push(e.replace("i","ī"),e.replace("i","í"),e.replace("i","ǐ"),e.replace("i","ì")),e.includes("o")&&n.push(e.replace("o","ō"),e.replace("o","ó"),e.replace("o","ǒ"),e.replace("o","ò")),e.includes("u")&&n.push(e.replace("u","ū"),e.replace("u","ú"),e.replace("u","ǔ"),e.replace("u","ù"))}),s=n}else if("a"===n)s=["我","你","他","她","的","是","在","有","个","了","到","上","下","来","去","好","很","都","不","没","看","说","做","吃","喝","走","跑","飞","开","关","大","小","高","矮","胖","瘦","快","慢","新","旧","多","少","长","短","远","近","里","外","中","边","前","后","左","右","东","西","南","北","白","黑","红","绿","黄","蓝","紫","粉","灰","棕","橙","青"];else if(d.length<=2)s=["a","I","it","is","to","be","of","in","on","at","or","an","as","by","we","he","me","my","up","so"];else{const e=["I","you","he","she","it","we","they","me","him","her","us","them"],n=["is","are","was","were","have","has","had","do","does","did","will","can","could","would","should","make","take","give","get","go","come","see","know","think","want"],t=["good","bad","big","small","new","old","happy","sad","fast","slow","hot","cold","easy","hard","beautiful","ugly"],i=["the","a","an","this","that","these","those"],r=["in","on","at","to","for","with","from","by","about","into","through","during","before","after"],a=["very","really","quite","too","so","just","still","already","yet","even","only","also","never","always","sometimes"];s=e.includes(d.toLowerCase())?e:n.includes(d.toLowerCase())?n:t.includes(d.toLowerCase())?t:i.includes(d.toLowerCase())?i:r.includes(d.toLowerCase())?r:a.includes(d.toLowerCase())?a:[...n.slice(0,5),...t.slice(0,5),...e.slice(0,5)]}const t=s.filter(e=>e.toLowerCase()!==d.toLowerCase());for(;e.length<(l.optionsCount||4)&&t.length>0;){const s=Math.floor(Math.random()*t.length),n=t[s];e.includes(n)||(e.push(n),t.splice(s,1))}for(;e.length<(l.optionsCount||4);){let s;s="b"===n?["shénme","nǎlǐ","zěnme","shéi"]:"a"===n?["什么","哪里","怎么","谁"]:["something","nothing","anything","everything"];const t=s[e.length-1]||`option${e.length}`;e.includes(t)||e.push(t)}j(e.sort(()=>Math.random()-.5))}},[e,l,d,c,r]),n.useEffect(()=>{if(e&&N.current){const e=N.current.getBoundingClientRect(),s=window.innerHeight,n=window.innerWidth;let t=e.bottom+10,i=e.left+e.width/2;t+300>s&&(t=e.top-310);const r=250;i-r/2<10?i=r/2+10:i+r/2>n-10&&(i=n-r/2-10),w({top:t,left:i})}},[e]);const b=n.useCallback(e=>{if("live"===l.checkMode){const s="b"===l.translationDirection.to?"pinyin":"text",n=Pe(e,d,2,s);f(n),x(!0)}else m(e)},[l,d,c]),T=n.useCallback(()=>{if(_){const e="b"===l.translationDirection.to?"pinyin":"text",s=Pe(_,d,2,e);f(s),x(!0),s&&o&&setTimeout(()=>{o()},1e3)}else x(!0)},[_,d,l,o]),I=n.useCallback(e=>{const s="b"===l.translationDirection.to?"pinyin":"text",n=Pe(e,d,2,s);f(n),x(!0),m(e),n&&o&&setTimeout(()=>{o()},1e3)},[d,l,o]);return t.jsxs("div",{ref:N,className:`\n        ${Ae}\n        ${e?$e:""}\n        ${s?ze:""}\n        ${!0===p?Be:""}\n        ${!1===p?Ee:""}\n      `,onClick:r,children:[t.jsx("span",{className:He,children:c}),e&&!g&&!C(c,d)&&t.jsxs("div",{className:We,style:{position:"fixed",top:`${k.top}px`,left:`${k.left}px`,transform:"translateX(-50%)"},children:[t.jsx("button",{className:qe,onClick:e=>{e.stopPropagation(),a&&a()},"aria-label":"Close input",title:"Close (to see translations below)",children:"✕"}),"free_text"===l.answerType?t.jsxs("div",{className:Ue,children:[t.jsx("input",{type:"text",value:_,onChange:e=>m(e.target.value),onKeyPress:e=>{"Enter"===e.key&&("live"===l.checkMode?b(_):T())},placeholder:"Type translation...",className:Fe,autoFocus:!0}),"wait"===l.checkMode&&t.jsx(i,{size:"small",variant:"primary",onClick:T,disabled:!_,children:"Check"})]}):t.jsx("div",{className:Re,children:v.map((e,s)=>t.jsx(i,{size:"small",variant:"secondary",onClick:()=>I(e),className:Oe,children:e},s))})]}),g&&t.jsxs("div",{className:Ge,children:[t.jsx("span",{className:Ke,children:d}),null!==p&&t.jsx("span",{className:p?Xe:Je,children:p?"✓":"✗"})]}),u&&!e&&t.jsx("span",{className:Ve,children:u}),h&&!e&&t.jsx("span",{className:Ye,children:h})]})},Ze="_container_14iex_3",es="_lineHeader_14iex_18",ss="_lineNumber_14iex_28",ns="_translationDirection_14iex_42",ts="_alignmentBadge_14iex_48",is="_lineContent_14iex_62",rs="_sideLabel_14iex_71",as="_sourceSide_14iex_106",os="_tokens_14iex_110",ls="_additionalSide_14iex_128",cs="_sideText_14iex_140",ds="_fullSentences_14iex_150",us="_fullSentence_14iex_150",hs=({line:e,deck:s,session:i,settings:r,onTokenClick:a,onTokenComplete:o})=>{const l=n.useMemo(()=>P(e),[e]),c=n.useMemo(()=>l?function(e){return D(e).map(e=>({...e,english:e.english.trim()||""}))}(e):[],[e,l]),d=n.useMemo(()=>{if(l)return null;const n=s.reading?.tokenization||{unit:{a:"character",b:"space",c:"space",d:void 0,e:void 0,f:void 0},preservePunctuation:!0};return((e,s)=>{const n=s||Ne;if(e.wordAlignments&&e.wordAlignments.length>0)return Se(e.wordAlignments);const t={},i=["a","b","c","d","e","f"];for(const r of i){const s=e[r];if(!s)continue;const i=n.unit[r];if(i)switch(i){case"character":t[r]=Ce(s,n.preservePunctuation);break;case"word":t[r]=be(s,n.preservePunctuation);break;case"space":t[r]=Te(s,n.preservePunctuation);break;default:t[r]=Ie(s,n.preservePunctuation)}}return t})(e,n)},[e,s,l]),u=n.useMemo(()=>{if(l&&c.length>0){return c.map((e,s)=>({text:e.chinese,start:s,end:s+1}))}if(!d)return[];const e=r.translationDirection.from;return d[e]||[]},[l,c,d,r]),h=n.useMemo(()=>{if(l&&c.length>0){const e=r.translationDirection.to;return c.map((s,n)=>({text:"b"===e?s.pinyin:s.english,start:n,end:n+1}))}if(!d)return[];const e=r.translationDirection.to;return d[e]||[]},[l,c,d,r]),_=n.useMemo(()=>l&&c.length>0?c.map((e,s)=>({text:e.pinyin,start:s,end:s+1})):d&&d.b||[],[l,c,d]),m=n.useCallback(e=>{a(e)},[a]),g=n.useCallback(()=>{o()},[o]),x=n.useCallback(e=>{if(!h.length)return"";const s=h[e];return s?.text||""},[h]),p=n.useCallback(e=>{if(!_.length)return"";const s=_[e];return s?.text||""},[_]),f=n.useCallback(e=>{if(!s.reading?.sides){return{a:"Characters",b:"Pinyin",c:"English",d:"Side D",e:"Side E",f:"Side F"}[e]||e.toUpperCase()}return s.reading.sides[e]||e.toUpperCase()},[s]);return t.jsxs("div",{className:Ze,children:[t.jsxs("div",{className:es,children:[t.jsxs("span",{className:ss,children:["Line ",i.currentLineIndex+1]}),t.jsxs("span",{className:ns,children:[f(r.translationDirection.from)," → ",f(r.translationDirection.to)]}),l&&t.jsx("span",{className:ts,children:"Word Aligned"})]}),t.jsxs("div",{className:is,children:[t.jsxs("div",{className:as,children:[t.jsxs("div",{className:rs,children:[f(r.translationDirection.from),l&&t.jsx("span",{className:ts,children:"Word Aligned"})]}),t.jsx("div",{className:os,children:u.map((e,s)=>t.jsx(Qe,{token:e,index:s,isActive:i.currentTokenIndex===s,isCompleted:!1,onClick:()=>m(s),onClose:()=>m(-1),onComplete:g,settings:r,sourceText:e.text,targetText:x(s),pinyinText:i.showPinyin?p(s):"",translationText:i.showTranslation?x(s):""},`${i.currentLineIndex}-${s}`))})]}),!l&&i.showPinyin&&e.b&&t.jsxs("div",{className:ls,children:[t.jsx("div",{className:rs,children:"Pinyin"}),t.jsx("div",{className:cs,children:e.b})]}),!l&&i.showTranslation&&t.jsxs("div",{className:ls,children:[t.jsx("div",{className:rs,children:f(r.translationDirection.to)}),t.jsx("div",{className:cs,children:e[r.translationDirection.to]||""})]}),l&&(i.showPinyin||i.showTranslation)&&t.jsxs("div",{className:ds,children:[i.showPinyin&&e.b&&t.jsxs("div",{className:us,children:[t.jsx("div",{className:rs,children:"Full Pinyin"}),t.jsx("div",{className:cs,children:e.b})]}),i.showTranslation&&e.c&&t.jsxs("div",{className:us,children:[t.jsx("div",{className:rs,children:"Full Translation"}),t.jsx("div",{className:cs,children:e.c})]})]})]})]})},_s="_container_u8uif_1",ms="_sentenceMode_u8uif_9",gs="_lineHeader_u8uif_15",xs="_lineNumber_u8uif_31",ps="_translationDirection_u8uif_40",fs="_additionalContent_u8uif_46",vs="_additionalSide_u8uif_53",js="_sideLabel_u8uif_64",ks="_sideText_u8uif_73",ws=({line:e,deck:s,session:i,settings:r,allLines:a,onAnswer:o,onTokenClick:l,onTokenComplete:c,onNext:d})=>{const u=n.useCallback(e=>{if(!s.reading?.sides){return{a:"Characters",b:"Pinyin",c:"English",d:"Side D",e:"Side E",f:"Side F"}[e]||e.toUpperCase()}return s.reading.sides[e]||e.toUpperCase()},[s]),h=n.useCallback(e=>{o&&o(e)},[o]),_=n.useMemo(()=>"sentence"===r.translationMode?t.jsxs("div",{className:ms,children:[t.jsxs("div",{className:gs,children:[t.jsxs("span",{className:xs,children:["Line ",i.currentLineIndex+1]}),t.jsxs("span",{className:ps,children:[u(r.translationDirection.from)," → ",u(r.translationDirection.to)]})]}),t.jsx(we,{line:e,allLines:a,settings:r,onAnswer:h,showResult:!0}),(i.showPinyin||i.showTranslation)&&t.jsxs("div",{className:fs,children:[i.showPinyin&&e.b&&t.jsxs("div",{className:vs,children:[t.jsx("div",{className:js,children:"Pinyin"}),t.jsx("div",{className:ks,children:e.b})]}),i.showTranslation&&e[r.translationDirection.to]&&t.jsxs("div",{className:vs,children:[t.jsx("div",{className:js,children:u(r.translationDirection.to)}),t.jsx("div",{className:ks,children:e[r.translationDirection.to]})]})]})]}):t.jsx(hs,{line:e,deck:s,session:i,settings:r,onTokenClick:l||(()=>{}),onTokenComplete:c||(()=>{})}),[r.translationMode,e,s,i,r,a,u,h,l,c]);return t.jsx("div",{className:_s,children:_})},Ns="_container_31tms_1",ys="_navigationControls_31tms_15",Cs="_navButton_31tms_21",bs="_toggleControls_31tms_29",Ts="_toggleButton_31tms_36",Is="_shortcuts_31tms_42",Ss="_shortcutHint_31tms_48",Ms=({canGoPrevious:e,canGoNext:s,showPinyin:n,showTranslation:r,onPrevious:a,onNext:o,onTogglePinyin:l,onToggleTranslation:c})=>t.jsxs("div",{className:Ns,children:[t.jsxs("div",{className:ys,children:[t.jsxs(i,{variant:"secondary",size:"medium",onClick:a,disabled:!e,className:Cs,children:[t.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:t.jsx("path",{d:"M19 12H5M5 12L12 19M5 12L12 5"})}),"Previous"]}),t.jsxs(i,{variant:"secondary",size:"medium",onClick:o,disabled:!s,className:Cs,children:["Next",t.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:t.jsx("path",{d:"M5 12H19M19 12L12 5M19 12L12 19"})})]})]}),t.jsxs("div",{className:bs,children:[t.jsxs(i,{variant:n?"primary":"secondary",size:"small",onClick:l,className:Ts,children:[n?t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"}),t.jsx("circle",{cx:"12",cy:"12",r:"3"})]}):t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"}),t.jsx("line",{x1:"1",y1:"1",x2:"23",y2:"23"})]}),"Pinyin (R)"]}),t.jsxs(i,{variant:r?"primary":"secondary",size:"small",onClick:c,className:Ts,children:[r?t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"}),t.jsx("circle",{cx:"12",cy:"12",r:"3"})]}):t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"}),t.jsx("line",{x1:"1",y1:"1",x2:"23",y2:"23"})]}),"Translation (T)"]})]}),t.jsx("div",{className:Is,children:t.jsx("span",{className:Ss,children:"Use ↑/↓ or J/K to navigate • R for pinyin • T for translation"})})]}),Ls="_container_bnqvl_1",Ds="_stats_bnqvl_15",Ps="_stat_bnqvl_15",As="_statLabel_bnqvl_35",$s="_statValue_bnqvl_42",zs="_correct_bnqvl_48",Bs="_incorrect_bnqvl_52",Es="_progressBar_bnqvl_56",Hs="_progressFill_bnqvl_64",Ws=({currentLineIndex:e,totalLines:s,correctCount:n,incorrectCount:i})=>{const r=(e+1)/s*100,a=n+i>0?n/(n+i)*100:0;return t.jsxs("div",{className:Ls,children:[t.jsxs("div",{className:Ds,children:[t.jsxs("div",{className:Ps,children:[t.jsx("span",{className:As,children:"Line"}),t.jsxs("span",{className:$s,children:[e+1," / ",s]})]}),(n>0||i>0)&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:Ps,children:[t.jsx("span",{className:As,children:"Correct"}),t.jsx("span",{className:`${$s} ${zs}`,children:n})]}),t.jsxs("div",{className:Ps,children:[t.jsx("span",{className:As,children:"Incorrect"}),t.jsx("span",{className:`${$s} ${Bs}`,children:i})]}),t.jsxs("div",{className:Ps,children:[t.jsx("span",{className:As,children:"Accuracy"}),t.jsxs("span",{className:$s,children:[a.toFixed(0),"%"]})]})]})]}),t.jsx("div",{className:Es,children:t.jsx("div",{className:Hs,style:{width:`${r}%`}})})]})},qs="_container_z6eft_1",Us="_leftPanel_z6eft_18",Fs="_mainPanel_z6eft_47",Rs="_settingsButton_z6eft_58",Os="_readPage_z6eft_64",Gs="_errorContainer_z6eft_69",Ks="_backButton_z6eft_90",Xs="_sentenceControls_z6eft_106",Js="_navButton_z6eft_114",Vs=()=>{const{deckId:e}=r(),s=a(),{currentDeck:u,isLoading:_,error:m,loadDeck:g}=o(),{session:x,settings:p,initSession:f,setCurrentDialogue:v,setCurrentLine:j,setCurrentToken:k,togglePinyin:w,toggleTranslation:N,recordAnswer:y,getProgress:C}=h(),[b,I]=n.useState(!1),[S,M]=n.useState(null);n.useEffect(()=>{e&&g(e)},[e,g]),n.useEffect(()=>{if(u?.reading&&e){const s=Object.keys(u.reading.dialogues);if(s.length>0){const n=C(e),t=n?.dialogueId||s[0];M(t),x||f(e,t)}}},[u,e,f,C]),n.useEffect(()=>{if(x&&e&&0===x.currentLineIndex&&0===x.currentTokenIndex){const s=C(e);s&&s.lineIndex>0&&(j(s.lineIndex),k(s.tokenIndex))}},[x?.currentDialogueId]);const L=n.useMemo(()=>u?.reading&&S?u.reading.dialogues[S]:null,[u,S]),D=n.useMemo(()=>L&&x?L.lines[x.currentLineIndex]:null,[L,x]),P=n.useMemo(()=>L?L.lines:[],[L]),A=n.useCallback(e=>{M(e),v(e),j(0),k(0)},[v,j,k]),$=n.useCallback(()=>{x&&x.currentLineIndex>0&&(j(x.currentLineIndex-1),k(0))},[x,j,k]),z=n.useCallback(()=>{x&&L&&x.currentLineIndex<L.lines.length-1&&(j(x.currentLineIndex+1),k(0))},[x,L,j,k]),B=n.useCallback(e=>{if(!x)return;const s=Date.now()-x.responseStartTime;y(e.isCorrect,s)},[x,y]);return n.useEffect(()=>{const e=e=>{const s=e.target;if(!s||"INPUT"!==s.tagName&&"TEXTAREA"!==s.tagName&&!s.isContentEditable)switch(e.key){case"ArrowUp":case"k":e.preventDefault(),$();break;case"ArrowDown":case"j":e.preventDefault(),z();break;case"r":e.preventDefault(),w();break;case"t":e.preventDefault(),N()}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[$,z,w,N]),n.useEffect(()=>()=>{},[x,e]),_?null:m||!u?t.jsxs("div",{className:Gs,children:[t.jsx("h2",{children:"Unable to load deck"}),t.jsx("p",{children:"The deck could not be loaded. Please try again."}),t.jsx("button",{onClick:()=>s("/"),className:Ks,children:"Back to Home"})]}):u.reading&&0!==Object.keys(u.reading.dialogues).length?t.jsxs("div",{className:Os,children:[t.jsx(l,{title:u.metadata.deck_name,subtitle:"Read Mode",onBackClick:()=>s(`/deck/${e}`),backLabel:"Back to Deck",rightContent:t.jsx(i,{variant:"secondary",size:"small",onClick:()=>I(!0),className:Rs,children:t.jsx(d,{size:20})})}),t.jsxs("div",{className:qs,children:[t.jsx("div",{className:Us,children:t.jsx(T,{deck:u,selectedDialogueId:S,onSelectDialogue:A,progress:C(e||"")})}),t.jsx("div",{className:Fs,children:x&&L&&D&&t.jsxs(t.Fragment,{children:[t.jsx(Ws,{currentLineIndex:x.currentLineIndex,totalLines:L.lines.length,correctCount:x.correctCount,incorrectCount:x.incorrectCount}),t.jsx(ws,{line:D,deck:u,session:x,settings:p,allLines:P,onAnswer:B,onNext:z,onTokenClick:e=>{k(e)},onTokenComplete:()=>{if(!x||!L)return;const e=x.currentTokenIndex+1,s=L.lines[x.currentLineIndex];e<(s.wordAlignments?s.wordAlignments.length:s.a?.length||0)?k(e):x.currentLineIndex<L.lines.length-1&&z()}}),"token"===p.translationMode&&t.jsx(Ms,{canGoPrevious:x.currentLineIndex>0,canGoNext:x.currentLineIndex<L.lines.length-1,showPinyin:x.showPinyin,showTranslation:x.showTranslation,onPrevious:$,onNext:z,onTogglePinyin:w,onToggleTranslation:N}),"sentence"===p.translationMode&&t.jsxs("div",{className:Xs,children:[t.jsx("button",{onClick:$,disabled:0===x.currentLineIndex,className:Js,children:"← Previous Sentence"}),t.jsx("button",{onClick:z,disabled:x.currentLineIndex>=L.lines.length-1,className:Js,children:"Next Sentence →"})]})]})})]}),b&&t.jsx(c,{visible:b,onClose:()=>I(!1),mode:"read",deck:u,settings:p,onUpdateSettings:e=>{h.getState().updateSettings(e)}})]}):t.jsxs("div",{className:Gs,children:[t.jsx("h2",{children:"No reading content available"}),t.jsx("p",{children:"This deck doesn't have any reading dialogues. Please choose a different deck."}),t.jsx("button",{onClick:()=>s(`/deck/${e}`),className:Ks,children:"Back to Deck"})]})};export{Vs as default};
