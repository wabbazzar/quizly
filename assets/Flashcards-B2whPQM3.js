import{h as e,p as s,r as t,j as r,A as a,m as n,f as o,u as c,d as i}from"./index-CoElTYbf.js";import{u as d}from"./cardMasteryStore-DLoKfaPt.js";import{u as l}from"./progressStore-CwmpBILf.js";import{s as u,F as m}from"./Flashcards.module-BzR01kDM.js";import{u as f,U as h}from"./UnifiedSettings-T8dbAibN.js";import{S as g}from"./SharedModeHeader-CqmUSN6k.js";import"./SettingsIcon-CGtfF6CW.js";const p=["side_a"],N=["side_b"],b=6048e5,C=e()(s((e,s)=>({sessions:new Map,getSession:e=>{const t=s().sessions.get(e);if(t)return Date.now()-t.lastAccessed>b?void s().clearSession(e):t},saveSession:s=>{e(e=>{const t=new Map(e.sessions);return t.set(s.deckId,{...s,lastAccessed:Date.now()}),{sessions:t}})},clearSession:s=>{e(e=>{const t=new Map(e.sessions);return t.delete(s),{sessions:t}})},clearOldSessions:()=>{e(e=>{const s=new Map,t=Date.now();return e.sessions.forEach((e,r)=>{t-e.lastAccessed<=b&&s.set(r,e)}),{sessions:s}})},startNewRound:(e,t)=>{const r=s().getSession(e),a={deckId:e,currentCardIndex:0,progress:{},frontSides:r?.frontSides||p,backSides:r?.backSides||N,lastAccessed:Date.now(),roundNumber:(r?.roundNumber||0)+1,cardOrder:Array.from({length:t},(e,s)=>s),startTime:Date.now(),isMissedCardsRound:!1,progressionMode:r?.progressionMode||"shuffle",includeMastered:void 0===r?.includeMastered||r.includeMastered};return s().saveSession(a),a},startMissedCardsRound:(e,t)=>{const r=s().getSession(e),a=[...t].sort(()=>Math.random()-.5),n={deckId:e,currentCardIndex:0,progress:{},frontSides:r?.frontSides||p,backSides:r?.backSides||N,lastAccessed:Date.now(),roundNumber:(r?.roundNumber||0)+1,cardOrder:a,startTime:Date.now(),isMissedCardsRound:!0,progressionMode:r?.progressionMode||"shuffle",includeMastered:void 0===r?.includeMastered||r.includeMastered};return s().saveSession(n),n},getMissedCardIndices:e=>{const s=[];return e.isMissedCardsRound?e.cardOrder.forEach((t,r)=>{"incorrect"!==e.progress[r]&&e.progress[r]||s.push(t)}):Object.entries(e.progress).forEach(([e,t])=>{"incorrect"===t&&s.push(parseInt(e))}),s}}),{name:"flashcard-session-store",storage:{getItem:e=>{const s=localStorage.getItem(e);if(!s)return null;const{state:t}=JSON.parse(s);return{state:{...t,sessions:new Map(t.sessions||[])}}},setItem:(e,s)=>{const{state:t}=s,r={state:{...t,sessions:Array.from(t.sessions.entries())}};localStorage.setItem(e,JSON.stringify(r))},removeItem:e=>localStorage.removeItem(e)}})),j="_overlay_zfoom_2",v="_modal_zfoom_14",S="_performanceHeader_zfoom_32",k="_performanceEmoji_zfoom_37",x="_performanceMessage_zfoom_53",_="_roundMessage_zfoom_60",M="_mainScore_zfoom_68",w="_accuracyDisplay_zfoom_73",y="_accuracyNumber_zfoom_80",I="_accuracyPercent_zfoom_87",$="_accuracyLabel_zfoom_94",D="_statsGrid_zfoom_101",R="_statCard_zfoom_108",A="_statValue_zfoom_116",z="_statLabel_zfoom_123",T="_roundInfo_zfoom_129",E="_roundBadge_zfoom_138",O="_missedCardsInfo_zfoom_147",B="_actionButtons_zfoom_159",F="_actionButton_zfoom_159",P="_primaryButton_zfoom_180",L="_secondaryButton_zfoom_196",U="_tertiaryButton_zfoom_212",W=({visible:e,results:s,onContinueWithMissed:o,onStartNewRound:c,onBackToDeck:i,onClose:d})=>{const l=s?Math.round(s.accuracy):0,u=s?s.endTime-s.startTime:0,m=Math.round(u/1e3),f=Math.floor(m/60),h=m%60,g=!!s&&s.missedCardIndices.length>0;return t.useEffect(()=>{if(!e||!s)return;const t=e=>{const t=e.target;if(t&&("INPUT"===t.tagName||"TEXTAREA"===t.tagName||t.isContentEditable))return;const r=s.missedCardIndices.length>0;"1"===e.key?(e.preventDefault(),r?o():c()):"2"===e.key&&r?(e.preventDefault(),c()):"3"===e.key&&(e.preventDefault(),i())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[e,s,o,c,i]),s?r.jsx(a,{children:e&&r.jsxs(r.Fragment,{children:[r.jsx(n.div,{className:j,initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:d}),r.jsxs(n.div,{className:v,initial:{opacity:0,scale:.9,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:20},transition:{type:"spring",stiffness:300,damping:30},children:[r.jsxs("div",{className:S,children:[r.jsx("div",{className:k,children:100===l?"ðŸ†":l>=90?"ðŸŒŸ":l>=75?"âœ¨":l>=60?"ðŸ‘":"ðŸ’ª"}),r.jsx("h2",{className:x,children:100===l?"Perfect Round!":l>=90?"Outstanding!":l>=75?"Great job!":l>=60?"Good effort!":"Keep practicing!"}),r.jsx("p",{className:_,children:s?1===s.roundNumber?g?`You completed Round ${s.roundNumber} with ${s.incorrectCards} card${1===s.incorrectCards?"":"s"} to review.`:`You completed Round ${s.roundNumber} perfectly!`:g?`Round ${s.roundNumber} complete! ${s.incorrectCards} card${1===s.incorrectCards?"":"s"} still need review.`:`Round ${s.roundNumber} complete! All cards mastered!`:""})]}),r.jsxs("div",{className:M,children:[r.jsxs("div",{className:w,children:[r.jsx("span",{className:y,children:l}),r.jsx("span",{className:I,children:"%"})]}),r.jsx("p",{className:$,children:"Accuracy"})]}),r.jsxs("div",{className:D,children:[r.jsxs("div",{className:R,children:[r.jsx("div",{className:A,children:s.correctCards}),r.jsx("div",{className:z,children:"Correct"})]}),r.jsxs("div",{className:R,children:[r.jsx("div",{className:A,children:s.incorrectCards}),r.jsx("div",{className:z,children:"Incorrect"})]}),r.jsxs("div",{className:R,children:[r.jsx("div",{className:A,children:s.totalCards}),r.jsx("div",{className:z,children:"Total Cards"})]}),r.jsxs("div",{className:R,children:[r.jsxs("div",{className:A,children:[f,":",h.toString().padStart(2,"0")]}),r.jsx("div",{className:z,children:"Time"})]})]}),r.jsxs("div",{className:T,children:[r.jsxs("div",{className:E,children:["Round ",s.roundNumber]}),g&&r.jsxs("div",{className:O,children:[s.incorrectCards," card",1===s.incorrectCards?"":"s"," to review"]})]}),r.jsxs("div",{className:B,children:[g?r.jsxs(r.Fragment,{children:[r.jsxs("button",{onClick:o,className:`${F} ${P}`,title:"Press 1 to continue",children:["Continue with Missed Cards (",s.incorrectCards,")"]}),r.jsx("button",{onClick:c,className:`${F} ${L}`,title:"Press 2 to start again",children:"Start Full Deck Again"})]}):r.jsx(r.Fragment,{children:r.jsx("button",{onClick:c,className:`${F} ${P}`,title:"Press 1 to start new round",children:"Start New Round"})}),r.jsx("button",{onClick:i,className:`${F} ${U}`,title:"Press 3 to go back",children:"Back to Deck"})]})]})]})}):null},G=()=>{const{deckId:e}=o(),s=c(),{decks:b,activeDeck:j,selectDeck:v}=i(),{getSession:S,saveSession:k,startNewRound:x,startMissedCardsRound:_,getMissedCardIndices:M}=C(),{updateDeckProgress:w}=l(),{updateSettings:y}=f(),I=t.useRef(!0),[$,D]=t.useState(0),[R,A]=t.useState(!1),[z,T]=t.useState(p),[E,O]=t.useState(N),[B,F]=t.useState({}),[P,L]=t.useState(!1),[U,G]=t.useState(null),[H,J]=t.useState(1),[X,Y]=t.useState([]),[q,K]=t.useState(Date.now()),[V,Q]=t.useState(!1),[Z,ee]=t.useState(!1),[se,te]=t.useState(null),[re,ae]=t.useState("shuffle"),[ne,oe]=t.useState(!0);t.useEffect(()=>{if(e){const t=b.find(s=>s.id===e);if(t){if(v(e),I.current){const s=S(e);if(s){D(s.currentCardIndex),F(s.progress),T(s.frontSides),O(s.backSides),J(s.roundNumber||1),K(s.startTime||Date.now()),Q(s.isMissedCardsRound||!1),ae(s.progressionMode||"shuffle");const r=void 0===s.includeMastered||s.includeMastered;if(oe(r),s.cardOrder&&!s.isMissedCardsRound){const{getMasteredCards:t}=d.getState(),a=t(e);if(!r&&a.length>0){const e=s.cardOrder.filter(e=>!a.includes(e));Y(e.length>0?e:s.cardOrder)}else Y(s.cardOrder)}else Y(s.cardOrder||Array.from({length:t.content.length},(e,s)=>s))}else{const{getMasteredCards:s}=d.getState(),r=s(e);let a=Array.from({length:t.content.length},(e,s)=>s);r.length>0&&(a=a.filter(e=>!r.includes(e)),oe(!1));const n=[...a];for(let e=n.length-1;e>0;e--){const s=Math.floor(Math.random()*(e+1));[n[e],n[s]]=[n[s],n[e]]}Y(n),K(Date.now())}I.current=!1}}else s("/")}},[e,b,v,s,S]),t.useEffect(()=>(document.body.classList.add("no-scroll"),()=>{document.body.classList.remove("no-scroll")}),[]),t.useEffect(()=>{e&&!I.current&&k({deckId:e,currentCardIndex:$,progress:B,frontSides:z,backSides:E,lastAccessed:Date.now(),roundNumber:H,cardOrder:X,startTime:q,isMissedCardsRound:V,progressionMode:re,includeMastered:ne})},[e,$,B,z,E,k,H,X,q,V,re,ne]);const ce=t.useCallback((s,t,r=!1)=>{if(!s||!e)return[];let a=Array.from({length:s.content.length},(e,s)=>s);if(r){const{getMasteredCards:s}=d.getState(),t=s(e);a=a.filter(e=>!t.includes(e))}switch(t){case"sequential":default:return a;case"shuffle":const e=[...a];for(let s=e.length-1;s>0;s--){const t=Math.floor(Math.random()*(s+1));[e[s],e[t]]=[e[t],e[s]]}return e;case"level":return a.sort((e,t)=>{const r=s.content[e].level-s.content[t].level;return 0!==r?r:e-t})}},[e]),ie=t.useCallback(()=>{if(!j||!e)return;const s={deckId:e,currentCardIndex:$,progress:B,frontSides:z,backSides:E,lastAccessed:Date.now(),roundNumber:H,cardOrder:X,startTime:q,isMissedCardsRound:V},t=M(s),r=X.length>0?X.length:j.content.length,a=Object.values(B).filter(e=>"correct"===e).length,n=Object.values(B).filter(e=>"incorrect"===e).length,o=a+n,c={deckId:e,totalCards:r,correctCards:a,incorrectCards:n,accuracy:o>0?a/o*100:0,roundNumber:H,isComplete:0===n,missedCardIndices:t,startTime:q,endTime:Date.now()};te(c),ee(!0),e&&w(e,"flashcards",o,a,o)},[j,e,$,B,z,E,H,X,q,V,M,w]),de=t.useCallback(()=>{if(!j)return;const e=X.length>0?X.length:j.content.length;$<e-1?(D(e=>e+1),A(!1)):ie()},[j,$,V,X,ie]),le=t.useCallback(()=>{$>0&&(D(e=>e-1),A(!1))},[$]),ue=t.useCallback(()=>{A(e=>!e)},[]),me=t.useCallback(e=>{F(s=>({...s,[$]:e})),G("correct"===e?"right":"left"),setTimeout(()=>{de(),G(null)},400)},[$,de]),fe=t.useCallback(()=>{if(!se||!e||!j)return;const s=se.missedCardIndices;let t;if("shuffle"===re){t=[...s];for(let e=t.length-1;e>0;e--){const s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}}else t="level"===re?[...s].sort((e,s)=>{const t=j.content[e].level-j.content[s].level;return 0!==t?t:e-s}):s;const r=_(e,t);D(0),A(!1),F({}),J(r.roundNumber),Y(t),K(r.startTime),Q(!0),ee(!1),te(null)},[se,e,j,_,re]),he=t.useCallback(()=>{if(!e||!j)return;const s=x(e,j.content.length),t=ce(j,re,!ne);D(0),A(!1),F({}),J(s.roundNumber),Y(t),K(s.startTime),Q(!1),ee(!1),te(null)},[e,j,x,ce,re,ne]),ge=t.useCallback(()=>{s(`/deck/${e}`)},[s,e]),pe=t.useCallback((e,s)=>{Math.abs(s.offset.x)>100&&(s.offset.x>0?me("correct"):me("incorrect"))},[me]),Ne=t.useCallback(s=>{const t=s.frontSides||z,r=s.backSides||E,a=s.progressionMode||re,n=void 0!==s.includeMastered?s.includeMastered:ne;T(t),O(r),A(!1);if((a!==re||n!==ne)&&j&&!V){ae(a),oe(n);const e=ce(j,a,!n);Y(e),D(0),F({})}else ae(a),oe(n);e&&y(e,"flashcards",s)},[re,ne,j,V,ce,z,E,e,y]),be=t.useCallback(e=>{const s=e.target;if(!s||"INPUT"!==s.tagName&&"TEXTAREA"!==s.tagName&&!s.isContentEditable)switch(e.key){case" ":e.preventDefault(),ue();break;case"ArrowRight":de();break;case"ArrowLeft":le();break;case"1":me("incorrect");break;case"2":me("correct")}},[ue,de,le,me]);if(t.useEffect(()=>(window.addEventListener("keydown",be),()=>window.removeEventListener("keydown",be)),[be]),!j)return null;const Ce=X.length>0?X[$]:$,je=j.content[Ce],ve=X.length>0?X.length:j.content.length,Se=Object.keys(B).length/ve*100,ke=Object.values(B).filter(e=>"correct"===e).length,xe=Object.values(B).filter(e=>"incorrect"===e).length;return r.jsxs("div",{className:u.container,children:[r.jsx(g,{deckName:j.metadata.deck_name,currentCard:$+1,totalCards:ve,onBackClick:()=>{s(`/deck/${e}`)},onSettingsClick:()=>L(!0),showSettings:!0,subtitle:[V?"Review":null,H>1?`Round ${H}`:null].filter(Boolean).join(" ")}),r.jsxs("div",{className:u.progressSection,children:[r.jsx("div",{className:u.progressBar,children:r.jsx("div",{className:u.progressFill,style:{width:`${Se}%`}})}),r.jsxs("div",{className:u.progressStats,children:[r.jsxs("span",{className:u.incorrectStat,children:["âœ— ",xe]}),r.jsxs("span",{className:u.correctStat,children:["âœ“ ",ke]})]})]}),r.jsx("main",{className:u.main,children:r.jsx(a,{mode:"wait",children:r.jsxs(n.div,{className:u.cardWrapper,drag:"x",dragConstraints:{left:0,right:0},dragElastic:1,onDragEnd:pe,style:{touchAction:"none"},initial:{y:window.innerHeight,opacity:0},animate:{y:0,opacity:1,x:"right"===U?window.innerWidth:"left"===U?-window.innerWidth:0,rotate:"right"===U?20:"left"===U?-20:0},exit:{opacity:0,transition:{duration:.2}},transition:{type:"spring",stiffness:300,damping:30},children:[r.jsx(m,{card:je,isFlipped:R,onFlip:ue,frontSides:z,backSides:E}),r.jsx("div",{className:`${u.swipeIndicator} ${u.incorrect}`,style:{opacity:"left"===U?1:0},children:"âœ—"}),r.jsx("div",{className:`${u.swipeIndicator} ${u.correct}`,style:{opacity:"right"===U?1:0},children:"âœ“"})]},$)})}),r.jsxs("div",{className:u.controls,children:[r.jsx("button",{className:u.navButton,onClick:le,disabled:0===$,"aria-label":"Previous card",children:"â†"}),r.jsxs("div",{className:u.actionButtons,children:[r.jsx("button",{className:`${u.markButton} ${u.incorrect}`,onClick:()=>me("incorrect"),"aria-label":"Mark as incorrect",children:"âœ— Incorrect"}),r.jsx("button",{className:u.flipButton,onClick:ue,"aria-label":"Flip card",children:"Flip"}),r.jsx("button",{className:`${u.markButton} ${u.correct}`,onClick:()=>me("correct"),"aria-label":"Mark as correct",children:"âœ“ Correct"})]}),r.jsx("button",{className:u.navButton,onClick:de,disabled:$===ve-1,"aria-label":"Next card",children:"â†’"})]}),r.jsx(h,{visible:P,onClose:()=>L(!1),deck:j,mode:"flashcards",settings:{frontSides:z,backSides:E,progressionMode:re,includeMastered:ne,enableTimer:!1,timerSeconds:30,enableAudio:!1,groupSides:{}},onUpdateSettings:e=>{Ne(e)}}),r.jsx(W,{visible:Z,results:se,onContinueWithMissed:fe,onStartNewRound:he,onBackToDeck:ge,onClose:()=>ee(!1)})]})};export{G as default};
